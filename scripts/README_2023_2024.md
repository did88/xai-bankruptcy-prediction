# DART 2023-2024년 기업 재무데이터 다운로드 가이드

기존 2015-2022년 데이터와 동일한 조건으로 2023-2024년 기업 재무데이터를 수집하는 스크립트입니다.

## 📋 준비사항

### 1. 환경 설정
- Python 3.7+ 설치
- 필수 라이브러리 설치: `pandas`, `aiohttp`, `openpyxl`, `python-dotenv`
- DART_API_KEY 환경변수 설정 또는 .env 파일 작성

### 2. API 키 설정
```bash
# 환경변수로 설정
export DART_API_KEY=your_api_key_here

# 또는 .env 파일에 작성
echo "DART_API_KEY=your_api_key_here" > .env
```

### 3. 필요한 파일들
- `dart_2023_2024_downloader.py` (메인 스크립트)
- `dart_bulk_downloader.py` (기존 다운로드 모듈)
- `download_2023_2024.bat` (Windows 배치 스크립트)
- `download_2023_2024.sh` (Linux/Mac 셸 스크립트)

## 🚀 사용 방법

### 방법 1: 배치/셸 스크립트 사용 (권장)

#### Windows
```batch
download_2023_2024.bat
```

#### Linux/Mac
```bash
chmod +x download_2023_2024.sh
./download_2023_2024.sh
```

### 방법 2: Python 스크립트 직접 실행

#### 1단계: 팀 정보 확인
```bash
python dart_2023_2024_downloader.py --list-teams
```

#### 2단계: 팀별 다운로드
```bash
# 예시: 팀 1 다운로드
python dart_2023_2024_downloader.py --team 1 --workers 10

# 예시: 팀 2 다운로드
python dart_2023_2024_downloader.py --team 2 --workers 10
```

#### 3단계: 2023-2024년 파일 병합
```bash
python dart_2023_2024_downloader.py --merge-only
```

#### 4단계: 기존 데이터와 병합
```bash
python dart_2023_2024_downloader.py --merge-all
```

## 📊 데이터 수집 조건

### 기존 2015-2022년과 동일한 조건:
- **대상 기업**: KOSPI/KOSDAQ 상장 비금융업종 기업
- **재무제표 타입**: 연결재무제표(CFS) 우선, 없으면 개별재무제표(OFS)
- **보고서 타입**: 사업보고서 (reprt_code: 11011)
- **수집 연도**: 2023년, 2024년

### 필터링 조건:
- 6자리 종목코드를 가진 상장기업만 포함
- 금융업종 제외 (은행, 보험, 증권, 투자 등)
- 유효한 재무데이터가 있는 기업만 수집

## 📁 출력 파일 구조

```
data/
├── team_downloads/
│   ├── dart_statements_2023_2024_team_01.xlsx
│   ├── dart_statements_2023_2024_team_02.xlsx
│   └── ...
├── dart_statements_2023_2024_merged.xlsx     # 2023-2024년 병합 파일
├── dart_statements_merged.xlsx               # 기존 2015-2022년 파일
└── dart_statements_2015_2024_merged.xlsx     # 최종 전체 병합 파일
```

## 🔧 고급 옵션

### 동시 작업 수 조정
```bash
# 더 빠른 다운로드 (서버 부하 주의)
python dart_2023_2024_downloader.py --team 1 --workers 20

# 더 안전한 다운로드
python dart_2023_2024_downloader.py --team 1 --workers 5
```

### 전체 팀 자동 다운로드
```bash
# 모든 팀을 순차적으로 다운로드 (시간이 매우 오래 걸림)
for i in {1..30}; do
    python dart_2023_2024_downloader.py --team $i --workers 10
done
```

## ⚡ 성능 최적화 팁

### 1. 팀별 분산 다운로드
- 여러 컴퓨터나 터미널에서 서로 다른 팀을 동시에 다운로드
- 예: 컴퓨터1은 팀 1-10, 컴퓨터2는 팀 11-20

### 2. API 제한 고려
- DART API는 분당 10,000회 제한
- `--workers` 옵션으로 동시 작업 수 조정 (기본값: 10)
- 오류 발생 시 workers 수를 줄여서 재시도

### 3. 네트워크 안정성
- 안정적인 인터넷 연결에서 실행
- 중간에 중단되면 완료된 팀부터 다시 시작 가능

## 🔍 데이터 검증

### 수집된 데이터 확인
```python
import pandas as pd

# 2023-2024년 데이터 확인
df_new = pd.read_excel('data/dart_statements_2023_2024_merged.xlsx')
print(f"2023-2024년 데이터: {len(df_new):,}행")
print(df_new['bsns_year'].value_counts().sort_index())

# 전체 데이터 확인
df_all = pd.read_excel('data/dart_statements_2015_2024_merged.xlsx')
print(f"전체 데이터 (2015-2024): {len(df_all):,}행")
print(df_all['bsns_year'].value_counts().sort_index())
```

### 데이터 품질 체크
```python
# 기업별 연도 커버리지 확인
coverage = df_all.groupby('corp_code')['bsns_year'].nunique()
print(f"평균 연도 커버리지: {coverage.mean():.1f}년")

# 누락된 연도 확인
missing_years = df_all.groupby('corp_code')['bsns_year'].apply(
    lambda x: set(range(2015, 2025)) - set(x)
)
```

## 🚨 주의사항

### 1. API 제한
- DART API 일일/월간 제한에 주의
- 과도한 요청 시 일시적 차단 가능성

### 2. 데이터 가용성
- 2023-2024년 데이터는 아직 모든 기업이 공시하지 않았을 수 있음
- 최신 데이터일수록 수집량이 적을 수 있음

### 3. 파일 크기
- 전체 데이터는 매우 클 수 있음 (수백 MB)
- 충분한 디스크 공간 확보 필요

## 🛠️ 문제 해결

### 1. API 키 오류
```
EnvironmentError: DART_API_KEY 환경변수를 설정하세요
```
→ API 키를 올바르게 설정했는지 확인

### 2. 연결 오류
```
aiohttp.ClientError: Connection timeout
```
→ 네트워크 연결 확인, workers 수 줄이기

### 3. 메모리 부족
```
MemoryError
```
→ 팀별로 나누어서 다운로드, 한 번에 너무 많은 데이터 처리 금지

### 4. 파일 권한 오류
```
PermissionError: [Errno 13] Permission denied
```
→ 출력 디렉토리 권한 확인, 관리자 권한으로 실행

## 📈 예상 소요 시간

| 팀 수 | 기업 수 | 예상 시간 | 권장 workers |
|-------|---------|-----------|--------------|
| 1팀   | ~100개  | 10-20분   | 10          |
| 5팀   | ~500개  | 1-2시간   | 10          |
| 전체  | ~3000개 | 6-12시간  | 5-10        |

## 💡 추천 워크플로우

1. **소규모 테스트**: 팀 1개로 먼저 테스트
2. **병렬 다운로드**: 여러 팀을 동시에 다운로드
3. **점진적 병합**: 완료된 팀부터 순차적으로 병합
4. **데이터 검증**: 최종 데이터의 완성도 확인
5. **기존 데이터 병합**: 2015-2022년 데이터와 통합

이 가이드를 따라 하면 기존 데이터와 일관성 있는 2023-2024년 데이터를 효율적으로 수집할 수 있습니다.
